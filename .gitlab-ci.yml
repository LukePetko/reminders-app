stages:
  - build
  - deploy

variables:
  APP_NAME: RemindersServer
  INSTALL_DIR: /Users/lukaspetko/RemindersServer
  SWIFT: /Library/Developer/Toolchains/swift-5.7.3-RELEASE.xctoolchain/usr/bin/swift

build:
  stage: build
  tags:
    - macos
  script:
    - $SWIFT --version
    - rm -rf .build/checkouts/swift-collections .build/checkouts/vapor
    - $SWIFT package resolve
    - nice -n 10 $SWIFT build -c release -j 2
    # Sign with ad-hoc signature and entitlements for consistent TCC permissions
    - codesign --force --sign - --entitlements RemindersServer.entitlements .build/release/RemindersServer
  artifacts:
    paths:
      - .build/release/RemindersServer
    expire_in: 1 hour

deploy:
  stage: deploy
  tags:
    - macos
  variables:
    PLIST_NAME: com.lukaspetko.remindersserver
  script:
    - export PLIST_PATH="$HOME/Library/LaunchAgents/com.lukaspetko.remindersserver.plist"
    - mkdir -p $INSTALL_DIR
    - mkdir -p "$HOME/Library/LaunchAgents"
    - cp .build/release/$APP_NAME $INSTALL_DIR/

    # Create launchd plist for the service
    - |
      cat > $PLIST_PATH << EOF
      <?xml version="1.0" encoding="UTF-8"?>
      <!DOCTYPE plist PUBLIC "-//Apple//DTD PLIST 1.0//EN" "http://www.apple.com/DTDs/PropertyList-1.0.dtd">
      <plist version="1.0">
      <dict>
        <key>Label</key>
        <string>$PLIST_NAME</string>
        <key>ProgramArguments</key>
        <array>
          <string>$INSTALL_DIR/$APP_NAME</string>
        </array>
        <key>WorkingDirectory</key>
        <string>$INSTALL_DIR</string>
        <key>EnvironmentVariables</key>
        <dict>
          <key>DB_HOST</key>
          <string>$DB_HOST</string>
          <key>DB_USER</key>
          <string>$DB_USER</string>
          <key>DB_PASS</key>
          <string>$DB_PASS</string>
          <key>DB_NAME</key>
          <string>$DB_NAME</string>
        </dict>
        <key>RunAtLoad</key>
        <true/>
        <key>KeepAlive</key>
        <true/>
        <key>StandardOutPath</key>
        <string>$INSTALL_DIR/app.log</string>
        <key>StandardErrorPath</key>
        <string>$INSTALL_DIR/app.log</string>
      </dict>
      </plist>
      EOF

    # Unload existing service (if running), then load the new one
    - launchctl unload $PLIST_PATH 2>/dev/null || true
    - launchctl load $PLIST_PATH

    # Verify service is running
    - sleep 2
    - launchctl list | grep $PLIST_NAME && echo "Service started successfully"
  only:
    - main
  dependencies:
    - build
