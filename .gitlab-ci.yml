stages:
  - build
  - deploy

variables:
  APP_NAME: RemindersServer
  INSTALL_DIR: /Users/lukaspetko/RemindersServer
  SWIFT: /Library/Developer/Toolchains/swift-5.7.3-RELEASE.xctoolchain/usr/bin/swift

build:
  stage: build
  tags:
    - macos
  script:
    - $SWIFT --version
    - rm -rf .build/checkouts/swift-collections .build/checkouts/vapor
    - $SWIFT package resolve
    - nice -n 10 $SWIFT build -c release -j 2
  artifacts:
    paths:
      - .build/release/RemindersServer
    expire_in: 1 hour

deploy:
  stage: deploy
  tags:
    - macos
  script:
    - mkdir -p $INSTALL_DIR
    # Kill existing process by PID file OR by name (fallback for first run)
    - if [ -f $INSTALL_DIR/app.pid ]; then kill $(cat $INSTALL_DIR/app.pid) 2>/dev/null || true; else pkill -f "$INSTALL_DIR/$APP_NAME" || true; fi
    - sleep 2
    - cp .build/release/$APP_NAME $INSTALL_DIR/
    - cd $INSTALL_DIR && DB_HOST=$DB_HOST DB_USER=$DB_USER DB_PASS=$DB_PASS DB_NAME=$DB_NAME nohup ./$APP_NAME </dev/null > app.log 2>&1 & echo $! > app.pid
    - sleep 3
    - cat $INSTALL_DIR/app.pid
    - ps -p $(cat $INSTALL_DIR/app.pid) || echo "Warning - process not running"
    - echo "Deploy complete"
  only:
    - main
  dependencies:
    - build
